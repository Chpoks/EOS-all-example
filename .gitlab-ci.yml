stages:
  - Generate
  - Execute

variables:
  GIT_CLEAN_FLAGS: none

"Generate":
  stage: Generate
  tags:
    - redpoint-games-windows
  script: |
    git submodule update --init BuildScripts
    if ($LastExitCode -ne 0) { exit $LastExitCode }
    .\BuildScripts\Lib\Patch_BuildGraph.ps1 -Engine 4.27
    .\BuildScripts\Lib\Patch_BuildGraph.ps1 -Engine 5.0
    $Distributions = @(
      "ClangTidy",
      "EOS_CPlusPlus",
      "GMF",
      "MM_SimpleBP",
      "MM_SimpleCPP",
      "OSB_EpicEOS",
      "OSB_LoginUI",
      "OSB_Null",
      "OSB_RedpointEOS",
      "OSB_Steam"
    )
    $Distributions_UE5 = @(
      "RSI"
    )
    foreach ($Dist in $Distributions) {
      .\BuildScripts\Generate.ps1 -Engine 4.27 -Distribution "$Dist" -GitLabYamlPath ".$Dist-4.27.gitlab-ci.yml" -GitLabAgentTagPrefix redpoint-games -WindowsSharedStorageAbsolutePath "X:\" -MapDriveForShorterPaths -MacSharedStorageAbsolutePath "/Volumes/BuildArtifacts/" -ExecuteTests
      .\BuildScripts\Generate.ps1 -Engine 5.0 -Distribution "$Dist" -GitLabYamlPath ".$Dist-5.0.gitlab-ci.yml" -GitLabAgentTagPrefix redpoint-games -WindowsSharedStorageAbsolutePath "X:\" -MapDriveForShorterPaths -MacSharedStorageAbsolutePath "/Volumes/BuildArtifacts/" -ExecuteTests
    }
    foreach ($Dist in $Distributions_UE5) {
      .\BuildScripts\Generate.ps1 -Engine 5.0 -Distribution "$Dist" -GitLabYamlPath ".$Dist-5.0.gitlab-ci.yml" -GitLabAgentTagPrefix redpoint-games -WindowsSharedStorageAbsolutePath "X:\" -MapDriveForShorterPaths -MacSharedStorageAbsolutePath "/Volumes/BuildArtifacts/" -ExecuteTests
    }
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "pipeline"'
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  artifacts:
    paths:
      - .*.gitlab-ci.yml
  variables:
    GIT_SUBMODULE_STRATEGY: none

"ClangTidy 4.27":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .ClangTidy-4.27.gitlab-ci.yml
        job: "Generate"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_TARGET == "ClangTidy"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - ClangTidy/**/*
        
"ClangTidy 5.0":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .ClangTidy-5.0.gitlab-ci.yml
        job: "Generate"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_TARGET == "ClangTidy"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - ClangTidy/**/*

"EOS_CPlusPlus 4.27":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .EOS_CPlusPlus-4.27.gitlab-ci.yml
        job: "Generate"
  variables: 
    UBT_CLANG_TIDY_EXTENSIONS: "false"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_TARGET == "EOS"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - EOS_CPlusPlus/**/*

"EOS_CPlusPlus 5.0":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .EOS_CPlusPlus-5.0.gitlab-ci.yml
        job: "Generate"
  variables: 
    UBT_CLANG_TIDY_EXTENSIONS: "false"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_TARGET == "EOS"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - EOS_CPlusPlus/**/*

"GMF 4.27":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .GMF-4.27.gitlab-ci.yml
        job: "Generate"
  variables: 
    UBT_CLANG_TIDY_EXTENSIONS: "false"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_TARGET == "GMF"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - GMF/**/*

"GMF 5.0":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .GMF-5.0.gitlab-ci.yml
        job: "Generate"
  variables: 
    UBT_CLANG_TIDY_EXTENSIONS: "false"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_TARGET == "GMF"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - GMF/**/*

"MM_SimpleBP 4.27":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .MM_SimpleBP-4.27.gitlab-ci.yml
        job: "Generate"
  variables: 
    UBT_CLANG_TIDY_EXTENSIONS: "false"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_TARGET == "MM"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - MM_SimpleBP/**/*

"MM_SimpleBP 5.0":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .MM_SimpleBP-5.0.gitlab-ci.yml
        job: "Generate"
  variables: 
    UBT_CLANG_TIDY_EXTENSIONS: "false"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_TARGET == "MM"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - MM_SimpleBP/**/*

"MM_SimpleCPP 4.27":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .MM_SimpleCPP-4.27.gitlab-ci.yml
        job: "Generate"
  variables: 
    UBT_CLANG_TIDY_EXTENSIONS: "false"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_TARGET == "MM"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - MM_SimpleCPP/**/*

"MM_SimpleCPP 5.0":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .MM_SimpleCPP-5.0.gitlab-ci.yml
        job: "Generate"
  variables: 
    UBT_CLANG_TIDY_EXTENSIONS: "false"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_TARGET == "MM"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - MM_SimpleCPP/**/*

"RSI 5.0":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .RSI-5.0.gitlab-ci.yml
        job: "Generate"
  variables: 
    UBT_CLANG_TIDY_EXTENSIONS: "false"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_TARGET == "RSI"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - RSI/**/*

"OSB_EpicEOS 4.27":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .OSB_EpicEOS-4.27.gitlab-ci.yml
        job: "Generate"
  variables: 
    UBT_CLANG_TIDY_EXTENSIONS: "false"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_TARGET == "OSB"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - OSB_EpicEOS/**/*

"OSB_EpicEOS 5.0":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .OSB_EpicEOS-5.0.gitlab-ci.yml
        job: "Generate"
  variables: 
    UBT_CLANG_TIDY_EXTENSIONS: "false"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_TARGET == "OSB"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - OSB_EpicEOS/**/*

"OSB_LoginUI 4.27":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .OSB_LoginUI-4.27.gitlab-ci.yml
        job: "Generate"
  variables: 
    UBT_CLANG_TIDY_EXTENSIONS: "false"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_TARGET == "OSB"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - OSB_LoginUI/**/*

"OSB_LoginUI 5.0":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .OSB_LoginUI-5.0.gitlab-ci.yml
        job: "Generate"
  variables: 
    UBT_CLANG_TIDY_EXTENSIONS: "false"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_TARGET == "OSB"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - OSB_LoginUI/**/*

"OSB_Null 4.27":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .OSB_Null-4.27.gitlab-ci.yml
        job: "Generate"
  variables: 
    UBT_CLANG_TIDY_EXTENSIONS: "false"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_TARGET == "OSB"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - OSB_Null/**/*

"OSB_Null 5.0":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .OSB_Null-5.0.gitlab-ci.yml
        job: "Generate"
  variables: 
    UBT_CLANG_TIDY_EXTENSIONS: "false"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_TARGET == "OSB"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - OSB_Null/**/*

"OSB_RedpointEOS 4.27":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .OSB_RedpointEOS-4.27.gitlab-ci.yml
        job: "Generate"
  variables: 
    UBT_CLANG_TIDY_EXTENSIONS: "false"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_TARGET == "OSB"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_TARGET == "EOS"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - OSB_RedpointEOS/**/*

"OSB_RedpointEOS 5.0":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .OSB_RedpointEOS-5.0.gitlab-ci.yml
        job: "Generate"
  variables: 
    UBT_CLANG_TIDY_EXTENSIONS: "false"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_TARGET == "OSB"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_TARGET == "EOS"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - OSB_RedpointEOS/**/*

"OSB_Steam 4.27":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .OSB_Steam-4.27.gitlab-ci.yml
        job: "Generate"
  variables: 
    UBT_CLANG_TIDY_EXTENSIONS: "false"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_TARGET == "OSB"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - OSB_Steam/**/*

"OSB_Steam 5.0":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .OSB_Steam-5.0.gitlab-ci.yml
        job: "Generate"
  variables: 
    UBT_CLANG_TIDY_EXTENSIONS: "false"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "pipeline" && $TRIGGER_TARGET == "OSB"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - OSB_Steam/**/*
