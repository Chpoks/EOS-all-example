stages:
  - Generate
  - Execute

variables:
  GIT_CLEAN_FLAGS: none

"Generate":
  stage: Generate
  tags:
    - redpoint-games-windows
  script: |
    git submodule update --init BuildScripts
    if ($LastExitCode -ne 0) { exit $LastExitCode }
    .\BuildScripts\Lib\Patch_BuildGraph.ps1 -Engine 4.27
    $Distributions = @(
      "ClangTidy",
      "EOS_CPlusPlus",
      "GMF",
      "MM_SimpleBP",
      "MM_SimpleCPP",
      "OSB_EpicEOS",
      "OSB_LoginUI",
      "OSB_Null",
      "OSB_RedpointEOS",
      "OSB_Steam",
      "RSI"
    )
    foreach ($Dist in $Distributions) {
      .\BuildScripts\Generate.ps1 -Engine 4.27 -Distribution "$Dist" -GitLabYamlPath ".$Dist.gitlab-ci.yml" -GitLabAgentTagPrefix redpoint-games -WindowsSharedStorageAbsolutePath "X:\" -MapDriveForShorterPaths -MacSharedStorageAbsolutePath "/Volumes/BuildArtifacts/"
    }
  only:
    refs:
      - main
      - merge_requests
  artifacts:
    paths:
      - .*.gitlab-ci.yml
  variables:
    GIT_SUBMODULE_STRATEGY: none

"ClangTidy":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .ClangTidy.gitlab-ci.yml
        job: "Generate"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - ClangTidy/**/*

"EOS_CPlusPlus":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .EOS_CPlusPlus.gitlab-ci.yml
        job: "Generate"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - EOS_CPlusPlus/**/*

"GMF":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .GMF.gitlab-ci.yml
        job: "Generate"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - GMF/**/*

"MM_SimpleBP":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .MM_SimpleBP.gitlab-ci.yml
        job: "Generate"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - MM_SimpleBP/**/*

"MM_SimpleCPP":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .MM_SimpleCPP.gitlab-ci.yml
        job: "Generate"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - MM_SimpleCPP/**/*

"RSI":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .RSI.gitlab-ci.yml
        job: "Generate"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - RSI/**/*

"OSB_EpicEOS":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .OSB_EpicEOS.gitlab-ci.yml
        job: "Generate"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - OSB_EpicEOS/**/*

"OSB_LoginUI":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .OSB_LoginUI.gitlab-ci.yml
        job: "Generate"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - OSB_LoginUI/**/*

"OSB_Null":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .OSB_Null.gitlab-ci.yml
        job: "Generate"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - OSB_Null/**/*

"OSB_RedpointEOS":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .OSB_RedpointEOS.gitlab-ci.yml
        job: "Generate"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - OSB_RedpointEOS/**/*

"OSB_Steam":
  stage: Execute
  needs:
    - "Generate"
  trigger:
    strategy: depend
    include:
      - artifact: .OSB_Steam.gitlab-ci.yml
        job: "Generate"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - OSB_Steam/**/*



